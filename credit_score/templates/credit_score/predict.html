{% extends 'base.html' %}
{% load static %}
{% load credit_app_extras %}

{% block title %}Одобрение кредита{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'credit_score/styles.css' %}">
{% endblock %}

{% block content %}
<div class="container-form">
    <h1>Прогноз одобрения кредита</h1>

    <form method="post">
        {% csrf_token %}

        {# Блок для ввода ИНН - всегда видим #}
        <div class="form-group">
            <label for="inn">ИНН клиента (для поиска):</label>
            <input type="text" id="inn" name="inn" value="{{ initial_data.inn|default:'' }}">
            <button type="submit" name="action" value="check_inn" class="btn-small">Найти клиента</button>
        </div>

        {# Если клиент найден по ИНН, отображаем его данные #}
        {% if client_info %}
            <div class="client-info">
                <h3>Найденный клиент:</h3>
                <ul>
                    <li>ФИО: <strong>{{ client_info.full_name }}</strong></li>
                    <li>ИНН: <strong>{{ client_info.inn }}</strong></li>
                    <li>Возраст: {{ client_info.age }}</li>
                    <li>Ежемесячный доход: {{ client_info.monthly_income }}</li>
                    <li>Коэффициент долговой нагрузки: {{ client_info.debt_ratio }}</li>
                    <li>Процент использования кредита: {{ client_info.utilization }}</li>
                    <li>Количество просрочек (30-59 дней): {{ client_info.num_30_59_days_past_due }}</li>
                    <li>Количество кредитных линий/займов: {{ client_info.num_credit_lines_loans }}</li>
                    {# Можно добавить другие поля, если нужно #}
                </ul>
            </div>
            {# Скрытые поля для передачи данных клиента в модель из client_info #}
            {% for feature in features %}
                <input type="hidden" name="{{ feature }}" value="{{ initial_data|get_item:feature|default:'0' }}">
            {% endfor %}
            <input type="hidden" name="full_name" value="{{ client_info.full_name }}">
            <input type="hidden" name="inn_found" value="{{ client_info.inn }}"> {# Используем другое имя, чтобы не конфликтовать с полем ввода ИНН #}

            {# Кнопка для получения прогноза с использованием данных найденного клиента #}
            <button type="submit" name="action" value="get_prediction_from_found_client">Получить прогноз (по клиенту)</button>

        {% else %}
            {# Если клиент НЕ найден по ИНН ИЛИ ИНН не был введен вовсе, отображаем поля для ручного ввода #}
            {# Также показываем сообщение, если ИНН вводили, но клиента не нашли #}
            {% if initial_data.inn and not client_info and request.method == 'POST' and request.POST.action == 'check_inn' %}
                <p class="error-message">Клиент с ИНН "<strong>{{ initial_data.inn }}</strong>" не найден. Пожалуйста, введите данные вручную:</p>
            {% else %}
                <h3>Или введите данные вручную:</h3>
            {% endif %}


            {# 6 полей для ручного ввода #}
            {% for feature in features %}
                <div class="form-group">
                    <label for="{{ feature }}">
                        {{ feature_names_ru|get_item:feature }} (<span class="feature-name">{{ feature }}</span>):
                    </label>
                    <input type="number" id="{{ feature }}" name="{{ feature }}" step="0.01"
                           value="{{ initial_data|get_item:feature|default:'0' }}" required>
                </div>
            {% endfor %}

            {# Кнопка для получения прогноза с использованием ручного ввода #}
            <button type="submit" name="action" value="get_prediction_from_manual_input">Получить прогноз (ручной ввод)</button>

        {% endif %}

    </form>

    {% if prediction %}
        <div class="prediction-result
            {% if "Одобрен" in prediction %}approved{% elif "Отклонен" in prediction %}declined{% else %}error{% endif %}">
            <p>Результат прогноза: <strong>{{ prediction }}</strong></p>
        </div>
    {% endif %}

</div>
{% endblock %}